import flixel.FlxG;
import flixel.FlxSprite;
import flixel.FlxCamera;
import flixel.util.FlxTimer;
import flixel.tweens.FlxEase;
import flixel.tweens.FlxTween;
import funkin.Paths;
import funkin.FunkinMemory;
import funkin.play.PlayState;
import funkin.play.stage.Stage;
import funkin.play.stage.StageProp;
import funkin.play.character.BaseCharacter;
import funkin.audio.FunkinSound;
import funkin.graphics.FunkinSprite;
import funkin.graphics.video.FunkinVideoSprite;
import funkin.modding.module.ModuleHandler;

class HillZonePhase2 extends Stage {
    public function new() {
        super("hillZonePhase2");
    }

    public var doScreenStatic:Bool = true;
    public var doCameraShake:Bool = true;
    public var allowCameraShake:Bool = true; // Used to disable camera shake via script
    public var doRedVignette:Bool = true;

    // Black things
    public var blackOverlay:FlxSprite;
	public var topBorder:FlxSprite;
	public var bottomBorder:FlxSprite;

    // Visual effects
    public var staticScreen:FunkinSprite;
    public var redVignette:FunkinSprite;
    
    // Props
    public var greenHill:StageProp;

    public var estaguyAnimation:FunkinVideoSprite;

    override function onCreate(event:ScriptEvent):Void {
        super.onCreate(event);

        FunkinMemory.cacheSound(Paths.sound("staticBUZZ", "shared"));

        doCameraShake = ModuleHandler.getModule("EXEOptions").scriptGet("doCameraShake");
        doScreenStatic = ModuleHandler.getModule("EXEOptions").scriptGet("screenstatic");

        greenHill = getNamedProp('GreenHill');

        // Jumpscares, static, etc
		staticScreen = FunkinSprite.createSparrow(100, 0, "daSTAT");
        staticScreen.animation.addByPrefix('static', 'staticFLASH', 30, false); // Speed it up
        staticScreen.animation.play('static');
		staticScreen.scale.set(FlxG.onMobile ? 6.15 : 5, FlxG.onMobile ? 5.1 : 5);
        staticScreen.zIndex = 5000;
		staticScreen.cameras = [PlayState.instance.camHUD];
		staticScreen.visible = false;
		staticScreen.animation.finishCallback = function() {
            staticScreen.visible = false;
        };
		PlayState.instance.add(staticScreen);

		redVignette = FunkinSprite.create(0, 0, 'RedVG');
		redVignette.zIndex = 1000;
        redVignette.scale.set(FlxG.onMobile ? 1.4 : 1, 1);
		redVignette.cameras = [PlayState.instance.camHUD];
        redVignette.alpha = 0;
		PlayState.instance.add(redVignette);

        blackOverlay = new FlxSprite(0, 0);
        blackOverlay.makeGraphic(FlxG.width, FlxG.height, 0xFF000000);
        blackOverlay.scrollFactor.set();
        blackOverlay.cameras = [PlayState.instance.camCutscene];
        blackOverlay.zIndex = 5000;
        blackOverlay.alpha = 0;
        PlayState.instance.add(blackOverlay);

        estaguyAnimation = new FunkinVideoSprite(0, 0);
        estaguyAnimation.cameras = [PlayState.instance.camCutscene];
        estaguyAnimation.zIndex = 5001;
        estaguyAnimation.bitmap.volumeAdjust = 0;
        estaguyAnimation.load('videos/videos/ycrencoreanimation.mp4');
    }
	function onNoteHit(event:HitNoteScriptEvent)
    {
        super.onNoteHit(event);

        if (!event.note.noteData.getMustHitNote() && doCameraShake && allowCameraShake)
        {
            if (event.note.holdNoteSprite != null)
            {
                FlxG.camera.shake(0.01, event.note.holdNoteSprite.sustainLength/1000);
            } else {
                FlxG.camera.shake(0.01, 0.2);
            }
        }
    }
    function startVideo():Void {
        estaguyAnimation.play();
        PlayState.instance.add(estaguyAnimation);
        new FlxTimer().start(14.2, function(timer:FlxTimer) { // The video is 14 seconds long
            estaguyAnimation.stop();
            PlayState.instance.remove(estaguyAnimation);
            //estaguyAnimation.destroy(); < -- This would make the video not replay if the song is restarted
		});
    }
    public function screenStatic():Void {
        if (!doScreenStatic) return;

		staticScreen.visible = true;
		staticScreen.animation.play('static');
		var staticScreenSound = FunkinSound.playOnce(Paths.sound("staticBUZZ"), 0.6);
		FlxTween.tween(staticScreenSound, { volume: 0 }, 1, {
			onComplete: function(tween:FlxTween) {
				staticScreenSound.stop();
			}
		});
    }
    public function switchStageArea(area:String):Void {
        switch (area) {
            case "greenHill":
                greenHill.zIndex = 2;
			    PlayState.instance.currentStage.refresh();
                return;
            case "normal":
                greenHill.zIndex = -50;
			    PlayState.instance.currentStage.refresh();
                return;
            default:
                return;
        }
    }
    override function buildStage()
	{
		super.buildStage();

		if (FlxG.onMobile) {
			getNamedProp('RunSky').scale.set(1.18, 1);
			getNamedProp('RunGround').scale.set(1.19, 1);
			getNamedProp('RunTopOverlay').scale.set(1.135, 1);
			getNamedProp('RunTrees').scale.set(1.14, 1);
			getNamedProp('RunBG').scale.set(1.19, 1);
			getNamedProp('GreenHill').scale.set(9.6, 9);
		}
	}
    function doVignette(mode:String):Void {
        if (!doRedVignette) return;
 
        FlxTween.tween(redVignette, { alpha: 0.5 }, 0.75, {
            ease: FlxEase.quadInOut,
            onComplete: function(tween:FlxTween) {
                FlxTween.tween(redVignette, { alpha: 0 }, 0.75, {
                    ease: FlxEase.quadInOut,
                });
            }
        });
    }
    override function onSongRetry(event:ScriptEvent):Void {
		super.onSongRetry(event);

        doRedVignette = false;
        switchStageArea("normal");
	}

    function onStepHit(event:SongTimeScriptEvent):Void {
        super.onStepHit(event);

        dad = PlayState.instance.currentStage.getDad();

        if (event.beat == 2 || event.beat % 35 == 0)
		{
            screenStatic();
		}
        if (event.step >= 80 && event.step % 20 == 0) { // bpm and song time is the same on both variations
            if (doRedVignette) doVignette();
        }

        // DEFAULT
        if (PlayState.instance.currentVariation == "default") {
            switch (event.step) {
                case 80:
                    doRedVignette = true;
                case 527:
                    switchStageArea("greenHill");
                    screenStatic();
                    doRedVignette = false;
                    allowCameraShake = false;
                case 783:
                    switchStageArea("normal");
                    screenStatic();
                    doRedVignette = true;
                    allowCameraShake = true;
            }
        }
        
        // ENCORE
        if (PlayState.instance.currentVariation == "encore") {
            switch (event.step) {
                case 80:
                    doRedVignette = true;
                case 528:
                    dad.x = dad.x + 720; // Encore pixel Sonic is used for Final Escape, instead of duplicating the character for YCRE, adjust offsets here
                    dad.y = dad.y + 900;
                    dad.cameraFocusPoint.x = dad.cameraFocusPoint.x + -350;
                    dad.cameraFocusPoint.y = dad.cameraFocusPoint.y + -200;
                    allowCameraShake = false;
                    doRedVignette = false;
                    switchStageArea("greenHill");
                    screenStatic();
                case 786: // This is weird because sometimes a lag spike can cause this to be skipped
                    doRedVignette = true;
                    allowCameraShake = true;
                    switchStageArea("normal");
                    screenStatic();
                case 1296:
                    FlxTween.tween(blackOverlay, { alpha: 1 }, 1); // Fade into cutscene
                case 1308:
                    startVideo();
                case 1439:
                    PlayState.instance.camCutscene.flash(0xFFFFFFFF, 1);
                    blackOverlay.alpha = 0;
            }
        }
    }
}